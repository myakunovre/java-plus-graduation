# API для комментариев

Данный документ описывает RESTful API для управления комментариями к событиям. API разделен на функциональность для авторизованных пользователей, администраторов и всех пользователей.

## Общие типы данных

### `NewCommentDto`
Используется для создания и редактирования комментариев.

```java
public class NewCommentDto {
    String text; // Текст комментария. Должен быть непустым и иметь длину от 20 до 7000 символов.
}
```


### `CommentShortDto`
Короткое представление комментария, возвращаемое при создании или при запросе пользователем, не являющимся автором данного комментария.

```java
public class CommentShortDto {
    Long id; // Идентификатор комментария
    String text; // Текст комментария
    EventShortDto event; // Краткая информация о событии
    UserDto author; // Информация об авторе комментария. Может отсутствовать, если null
    LocalDateTime createdOn; // Дата и время создания комментария. Может отсутствовать, если null
}
```

### `CommentFullDto`
Полное представление комментария, возвращаемое при изменении комментрия, а также при запросе автором комментрия или администратором (дополнительно включает его статус и дату публикации).

```java
public class CommentFullDto {
    Long id; // Идентификатор комментария
    String text; // Текст комментария
    EventShortDto event; // Краткая информация о событии
    UserDto author; // Информация об авторе комментария
    LocalDateTime createdOn; // Дата и время создания комментария
    LocalDateTime publishedOn; // Дата и время публикации комментария
    LocalDateTime modifiedOn; // Дата и время публикации измененного комментария
    State state; // Текущий статус комментария (PUBLISHED, CANCELED, PENDING)
}
```


### `State`
Перечисление для статуса комментария.

```java
public enum State {
    PUBLISHED, // Опубликован
    CANCELED, // Отменен
    PENDING   // В ожидании модерации
}
```

## Эндпоинты для авторизованных пользователей

### 1. Добавление комментария к событию

`POST /users/{userId}/events/{eventId}/comments`

Добавляет новый комментарий к указанному событию от имени пользователя.

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя (автора комментария).
*   `eventId`: `Long` - Идентификатор события, к которому добавляется комментарий.

**Тело запроса:**
`NewCommentDto`

**Ограничения:**
*   Текст комментария не должен быть пустым.
*   Длина текста должна быть от 20 до 7000 символов.

**Ответы:**

*   **`201 Created`** - Успешное добавление комментария.
    *   **Тело ответа:** `CommentShortDto`
*   **`400 Bad Request`** - Неверные параметры запроса (пустой текст, неправильная длина текста).
*   **`404 Not Found`** - Событие или пользователь не найдены.
*   **`409 Conflict`** - Событие не опубликовано.

### 2. Редактирование своего комментария

`PATCH /users/{userId}/events/{eventId}/comments/{commentId}`

Редактирует существующий комментарий пользователя. При изменении опубликованного комментария его статус меняется на `PENDING`.

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя (владельца комментария).
*   `eventId`: `Long` - Идентификатор события, к которому относится комментарий.
*   `commentId`: `Long` - Идентификатор редактируемого комментария.

**Тело запроса:**
`NewCommentDto`

**Ограничения:**
*   Текст комментария не должен быть пустым.
*   Длина текста должна быть от 20 до 7000 символов.

**Ответы:**

*   **`200 OK`** - Успешное редактирование комментария.
    *   **Тело ответа:** `CommentFullDto`
*   **`400 Bad Request`** - Неверные параметры запроса (пустой текст, неправильная длина текста).
*   **`403 Forbidden`** - Комментарий не принадлежит указанному пользователю.
*   **`404 Not Found`** - Пользователь, событие или комментарий не найдены.
*   **`409 Conflict`** - Комментарий отклонен, и его нельзя редактировать.

### 3. Удаление своего комментария

`DELETE /users/{userId}/events/{eventId}/comments/{commentId}`

Удаляет комментарий, принадлежащий текущему пользователю.

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя (владельца комментария).
*   `eventId`: `Long` - Идентификатор события, к которому относится комментарий.
*   `commentId`: `Long` - Идентификатор удаляемого комментария.

**Тело запроса:**
`отсутствует

**Ответы:**

*   **`200 OK`** - Успешное удаление комментария.
    *   **Тело ответа:** Отсутствует.
*   **`403 Forbidden`** - Комментарий не принадлежит указанному пользователю.
*   **`404 Not Found`** - Комментарий не найден.

### 4. Получение своих комментариев

`GET /users/{userId}/comments`

Получает список комментариев, написанных текущим пользователем, с возможностью фильтрации по статусу и пагинации.

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя.

**Параметры запроса (Query Parameters):**
*   `status`: `String` - Статус комментариев для фильтрации (`"PUBLISHED"`, `"CANCELED"`, `"PENDING"`, `"ALL"`). **Обязательный.**
*   `from`: `Integer` - (По умолчанию `0`) Количество элементов, которые нужно пропустить.
*   `size`: `Integer` - (По умолчанию `10`) Количество элементов в наборе.

**Ограничения:**
*   `from` не может быть отрицательным.
*   `size` не может быть отрицательным.

**Ответы:**

*   **`200 OK`** - Успешное получение списка комментариев.
    *   **Тело ответа:** Список `CommentFullDto` (может быть пустым, если комментарии не найдены).
*   **`400 Bad Request`** - Неверно указан статус (или отсутствует), или `from`/`size` имеют некорректные значения.
*   **`404 Not Found`** - Пользователь не найден.

### 5. Получение определённого комментария по ID

`GET /users/{userId}/events/{eventId}/comments/{commentId}`

Получает информацию об определенном комментарии.

**Особенности:**
*   Если запрошен свой комментарий, возвращается `CommentFullDto`.
*   Если запрошен чужой комментарий: 
    * возвращается также `CommentFullDto`, но с полями `publishedOn` и `state` равными null;
    * при этом комментарий должен быть опубликованным (`PUBLISHED`).

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя.
*   `eventId`: `Long` - Идентификатор события, к которому относится комментарий.
*   `commentId`: `Long` - Идентификатор комментария.

**Ответы:**

*   **`200 OK`** - Успешное получение комментария.
    *   **Тело ответа:** `CommentFullDto`
*   **`403 Forbidden`** - Запрошен чужой неопубликованный (не `PUBLISHED`) комментарий.
*   **`404 Not Found`** - Пользователь, событие или комментарий не найдены.

### 6. Получение всех опубликованных комментариев к событию (для пользователя)

`GET /users/{userId}/events/{eventId}/comments`

Получает список всех опубликованных (`PUBLISHED`) комментариев к указанному событию.

**URL-параметры:**
*   `userId`: `Long` - Идентификатор пользователя.
*   `eventId`: `Long` - Идентификатор события.

**Параметры запроса (Query Parameters):**
*   `from`: `Integer` - (По умолчанию `0`) Количество элементов, которые нужно пропустить.
*   `size`: `Integer` - (По умолчанию `10`) Количество элементов в наборе.

**Ограничения:**
*   `from` не может быть отрицательным.
*   `size` не может быть отрицательным.

**Тело запроса:**
`отсутствует

**Ответы:**

*   **`200 OK`** - Успешное получение списка комментариев.
    *   **Тело ответа:** Список `CommentShortDto` (может быть пустым, если комментарии не найдены).
*   **`400 Bad Request`** - `from`/`size` имеют некорректные значения.
*   **`404 Not Found`** - Пользователь или событие не найдены.

---
## Эндпоинты для администратора

### 1. Получение комментариев (для администратора)

`GET /admin/comments`

Получает список комментариев с возможностью фильтрации по статусу, дате создания и пагинации.

**Параметры запроса (Query Parameters):**
*   `state`: `String` - (По умолчанию `ALL`) Статус комментариев для фильтрации (`"PUBLISHED"`, `"CANCELED"`, `"PENDING"`, `"ALL"`).
*   `rangeStart`: `String` (ISO-формат: `yyyy-MM-dd HH:mm:ss`) - Дата и время, не раньше которых был создан комментарий. **Обязательный.**
*   `rangeEnd`: `String` (ISO-формат: `yyyy-MM-dd HH:mm:ss`) - Дата и время, не позже которых был создан комментарий. **Обязательный.**
*   `from`: `Integer` - (По умолчанию `0`) Количество элементов, которые нужно пропустить.
*   `size`: `Integer` - (По умолчанию `10`) Количество элементов в наборе.

**Ограничения:**
*   `rangeStart` и `rangeEnd` должны быть указаны.
*   `rangeStart` не может быть позже `rangeEnd`.
*   `from` не может быть отрицательным.
*   `size` не может быть отрицательным.

**Тело запроса:**
`отсутствует

**Ответы:**

*   **`200 OK`** - Успешное получение списка комментариев.
    *   **Тело ответа:** Список `CommentFullDto` (может быть пустым, если комментарии не найдены).
*   **`400 Bad Request`** - Неверно указан статус, `rangeStart`/`rangeEnd` не указаны или `rangeStart` позже `rangeEnd`, или `from`/`size` имеют некорректные значения.

### 2. Одобрение/отклонение комментария

`PATCH /admin/comments/{commentId}`

Изменяет статус комментария (одобряет или отклоняет). Комментарий должен быть в состоянии `PENDING`.
При первичном запросе (комментарий еще не публиковался) заполняется дата публикации.
При повторном запросе (опубликованный комментарий отредактирован автором) дата публикации не меняется, а заполняется дата изменения.

**URL-параметры:**
*   `commentId`: `Long` - Идентификатор комментария.

**Параметры запроса (Query Parameters):**
*   `action`: `String` - Действие (`"APPROVE"` для одобрения, `"REJECT"` для отклонения). **Обязательный.**

**Ограничения:**
*   `action` должен быть `"APPROVE"` или `"REJECT"`.

**Тело запроса:**
`отсутствует

**Ответы:**

*   **`200 OK`** - Успешное обновление статуса комментария.
    *   **Тело ответа:** `CommentFullDto`
*   **`400 Bad Request`** - Неверно указан `action`.
*   **`409 Conflict`** - Комментарий не находится в состоянии `PENDING`.

### 3. Удаление комментария (для администратора)

`DELETE /admin/comments/{commentId}`

Полностью удаляет комментарий.

**URL-параметры:**
*   `commentId`: `Long` - Идентификатор удаляемого комментария.

**Ответы:**

*   **`200 OK`** - Успешное удаление комментария.
    *   **Тело ответа:** Отсутствует.
*   **`404 Not Found`** - Комментарий не найден.

---
## Эндпоинты для всех пользователей

### 1. Получение опубликованных комментариев к событию (для всех)

`GET /events/{eventId}/comments`

Получает список всех опубликованных (`PUBLISHED`) комментариев к указанному событию.

**URL-параметры:**
*   `eventId`: `Long` - Идентификатор события.

**Параметры запроса (Query Parameters):**
*   `from`: `Integer` - (По умолчанию `0`) Количество элементов, которые нужно пропустить.
*   `size`: `Integer` - (По умолчанию `10`) Количество элементов в наборе.

**Ограничения:**
*   `from` не может быть отрицательным.
*   `size` не может быть отрицательным.

**Ответы:**

*   **`200 OK`** - Успешное получение списка комментариев.
    *   **Тело ответа:** Список `CommentShortDto` (может быть пустым, если комментарии не найдены).
*   **`400 Bad Request`** - `from`/`size` имеют некорректные значения.
*   **`404 Not Found`** - Событие не найдено.